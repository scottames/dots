#!/usr/bin/env bash
# awww-random-wallpaper [DIRECTORY] [INTERVAL]
# Uses env vars if set:
#   AWWW_WALLPAPER_DIR
#   AWWW_WALLPAPER_INTERVAL
#   AWWW_RESIZE_TYPE
#   AWWW_TRANSITION_FPS
#   AWWW_TRANSITION_STEP
#   AWWW_NAMESPACE
#   AWWW_MAX_TRIES_PER_IMG

set -u # keep undefined-var safety, but handle errors manually below

DEFAULT_INTERVAL=300
DEFAULT_NAMESPACE="niri"
DEFAULT_MAX_TRIES=10

DIR="${AWWW_WALLPAPER_DIR:-${1-}}"
INTERVAL="${AWWW_WALLPAPER_INTERVAL:-${2:-${DEFAULT_INTERVAL}}}"
AWWW_NAMESPACE="${AWWW_NAMESPACE:-${DEFAULT_NAMESPACE}}"
AWWW_RESIZE_TYPE="${AWWW_RESIZE_TYPE:-fit}" # See awww-img(1)
AWWW_MAX_TRIES_PER_IMG="${AWWW_MAX_TRIES_PER_IMG:-${DEFAULT_MAX_TRIES}}"

if [[ -z ${DIR} ]] || [[ ! -d ${DIR} ]]; then
  printf "Usage:\n\t%s [DIRECTORY] [INTERVAL]\n" "$0" >&2
  printf "\tDIRECTORY must exist (or AWWW_WALLPAPER_DIR must be set).\n" >&2
  printf "\tINTERVAL is in seconds (or AWWW_WALLPAPER_INTERVAL, default: %d).\n" "${DEFAULT_INTERVAL}" >&2
  exit 1
fi

# Transition defaults
export AWWW_TRANSITION_FPS="${AWWW_TRANSITION_FPS:-60}"
export AWWW_TRANSITION_STEP="${AWWW_TRANSITION_STEP:-2}"

awww_set_img() {
  img="$1"
  tries=0

  while :; do
    awww img \
      --namespace "${AWWW_NAMESPACE}" \
      --resize="${AWWW_RESIZE_TYPE}" \
      "${img}" &&
      return 0

    tries=$((tries + 1))
    printf 'awww: failed to set "%s" (try %d/%d), waiting for daemon/Waylandâ€¦\n' \
      "${img}" "${tries}" "${AWWW_MAX_TRIES_PER_IMG}" >&2

    if [[ ${tries} -ge ${AWWW_MAX_TRIES_PER_IMG} ]]; then
      printf 'awww: giving up on "%s", moving on.\n' "${img}" >&2
      return 1
    fi

    sleep 1
  done
}

while :; do
  find "${DIR}" -type f -print0 |
    shuf -z |
    while IFS= read -r -d '' img; do
      if awww_set_img "${img}"; then
        # Only sleep full interval if we successfully set the image
        sleep "${INTERVAL}"
      else
        # If we gave up on this image, don't stall too long before trying the next
        sleep 1
      fi
    done
done
