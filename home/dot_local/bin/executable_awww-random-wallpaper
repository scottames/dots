#!/usr/bin/env bash
#
# awww-random-wallpaper [DIRECTORY] [INTERVAL]
#
# Uses env vars if set:
#   AWWW_WALLPAPER_DIR
#   AWWW_WALLPAPER_CHANGE_INTERVAL
#   AWWW_RESIZE_TYPE
#   AWWW_TRANSITION_FPS
#   AWWW_TRANSITION_STEP
#   AWWW_TRANSITION_TYPE
#   AWWW_NAMESPACE
#   AWWW_MAX_TRIES_PER_IMG
#   AWWW_VERIFY_INTERVAL_SEC
#   AWWW_VERIFY_TIMEOUT_SEC

set -u # keep undefined-var safety, but handle errors manually below

AWWW_WALLPAPER_DIR="${AWWW_WALLPAPER_DIR:-${1-}}"
AWWW_WALLPAPER_CHANGE_INTERVAL="${AWWW_WALLPAPER_CHANGE_INTERVAL:-${2:-300}}"
AWWW_MAX_TRIES_PER_IMG="${AWWW_MAX_TRIES_PER_IMG:-15}" # times we retry the *whole* set+verify
AWWW_NAMESPACE="${AWWW_NAMESPACE:-niri}"
AWWW_RESIZE_TYPE="${AWWW_RESIZE_TYPE:-fit}" # See awww-img(1)
AWWW_TRANSITION_FPS="${AWWW_TRANSITION_FPS:-60}"
AWWW_TRANSITION_STEP="${AWWW_TRANSITION_STEP:-2}"
AWWW_TRANSITION_TYPE="${AWWW_TRANSITION_TYPE:-random}"
AWWW_VERIFY_INTERVAL_SEC="${AWWW_VERIFY_INTERVAL_SEC:-1}"
AWWW_VERIFY_TIMEOUT_SEC="${AWWW_VERIFY_TIMEOUT_SEC:-5}"

if [[ -z ${AWWW_WALLPAPER_DIR} ]] || [[ ! -d ${AWWW_WALLPAPER_DIR} ]]; then
  printf "Usage:\n\t%s [DIRECTORY] [INTERVAL]\n\n" "$0" >&2
  printf "Arguments:\n" >&2
  printf "\tAWWW_WALLPAPER_DIR - Path to wallpaper directory (required)\n" >&2
  printf "\tAWWW_WALLPAPER_CHANGE_INTERVAL  - Seconds between wallpaper changes (default: %d)\n\n" "${AWWW_WALLPAPER_CHANGE_INTERVAL}" >&2
  printf "Environment Variables:\n" >&2
  printf "\tAWWW_WALLPAPER_DIR             - Wallpaper directory\n" >&2
  printf "\tAWWW_WALLPAPER_CHANGE_INTERVAL - Change interval in seconds (default: %d)\n" "${AWWW_WALLPAPER_CHANGE_INTERVAL}" >&2
  printf "\tAWWW_RESIZE_TYPE               - Image resize type (default: %s)\n" "${AWWW_RESIZE_TYPE}" >&2
  printf "\tAWWW_TRANSITION_FPS            - Transition FPS (default: %d)\n" "${AWWW_TRANSITION_FPS}" >&2
  printf "\tAWWW_TRANSITION_STEP           - Transition step (default: %d)\n" "${AWWW_TRANSITION_STEP}" >&2
  printf "\tAWWW_TRANSITION_TYPE           - Transition type (default: %s)\n" "${AWWW_TRANSITION_TYPE}" >&2
  printf "\tAWWW_NAMESPACE                 - awww namespace (default: %s)\n" "${AWWW_NAMESPACE}" >&2
  printf "\tAWWW_MAX_TRIES_PER_IMG         - Max retries per image (default: %d)\n" "${AWWW_MAX_TRIES_PER_IMG}" >&2
  printf "\tAWWW_VERIFY_INTERVAL_SEC       - Polling interval for verification (default: %d)\n" "${AWWW_VERIFY_INTERVAL_SEC}" >&2
  printf "\tAWWW_VERIFY_TIMEOUT_SEC        - Timeout for image verification (default: %d)\n" "${AWWW_VERIFY_TIMEOUT_SEC}" >&2
  exit 1
fi

awww_is_showing() {
  # returns 0 if any output in the namespace is currently displaying IMG
  #   otherwise returns 1
  local img wanted
  img="$1"
  # Normalize both sides
  wanted="$(readlink -f -- "$img" 2>/dev/null || realpath -- "$img" 2>/dev/null || echo "$img")"

  # 'awww query' prints lines like:
  # niri: DP-2: 5120x1440, scale: 1, currently displaying: image: /path/to.jpg
  awww query --namespace "$AWWW_NAMESPACE" 2>/dev/null |
    awk -F'image: ' 'NF>1 {print $2}' |
    while IFS= read -r path; do
      local shown
      shown="$(readlink -f -- "$path" 2>/dev/null || realpath -- "$path" 2>/dev/null || echo "$path")"
      [[ $shown == "$wanted" ]] && exit 0
    done

  return 1 # If the while loop above didn't exit 0, awk ended → not showing
}

awww_set_img() {
  local img tries=0
  img="$1"

  while :; do
    # Attempt to set the image (don’t assume success means “visible”)
    awww img \
      --namespace "$AWWW_NAMESPACE" \
      --resize="$AWWW_RESIZE_TYPE" \
      --transition-fps="$AWWW_TRANSITION_FPS" \
      --transition-step="$AWWW_TRANSITION_STEP" \
      --transition-type="$AWWW_TRANSITION_TYPE" \
      -- "$img" || true

    # Poll 'awww query' until it reports our image or we time out
    local waited=0
    while (($(echo "$waited < $AWWW_VERIFY_TIMEOUT_SEC" | bc -l))); do
      if awww_is_showing "$img"; then
        return 0
      fi
      sleep "$AWWW_VERIFY_INTERVAL_SEC"
      waited=$(echo "$waited + $AWWW_VERIFY_INTERVAL_SEC" | bc)
    done

    # Didn’t become visible in time → retry the whole cycle
    tries=$((tries + 1))
    printf 'awww: image not active after %.2fs (try %d/%d): %s\n' \
      "$AWWW_VERIFY_TIMEOUT_SEC" "$tries" "$AWWW_MAX_TRIES_PER_IMG" "$img" >&2

    if ((tries >= AWWW_MAX_TRIES_PER_IMG)); then
      printf 'awww: giving up on "%s", moving on.\n' "$img" >&2
      return 1
    fi

    sleep 1
  done
}

while :; do
  find "${AWWW_WALLPAPER_DIR}" -type f -print0 |
    shuf -z |
    while IFS= read -r -d '' img; do
      if awww_set_img "${img}"; then
        # Only sleep full interval if we successfully set the image
        sleep "${AWWW_WALLPAPER_CHANGE_INTERVAL}"
      else
        # If we gave up on this image, don't stall too long before trying the next
        sleep 1
      fi
    done
done
